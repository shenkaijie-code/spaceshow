<template>

  <div class="home">
    <el-row>
      <el-col :span="15">
        <div id="map" ref="map" class="map__x"></div>
      </el-col>
      <el-col :span="9">
        <el-row>
          <div>
            <button @click="drawPoint">画点</button>
            <button @click="drawLine">画线</button>
            <button @click="drawPolygon">画面</button>
            <button @click="drawCircle">画圆</button>
            <button @click="removeLastPoint">撤回</button>
            <button @click="clearDraw">清空</button>
            <button @click="exitDraw">退出</button>
          </div>
        </el-row>
        <el-row type="flex" justify="center">
          <el-col :span="2">坐标</el-col>
          <el-col :span="22">
            <el-text class="mx-1" type="danger">
              <div id='points'></div>
              <div id='wkt'></div>
            </el-text>
          </el-col>
        </el-row>
        <!--        <el-row>
                  <el-form :model="ruleForm" status-icon ref="formRef" label-width="120px">
                    <el-row :gutter="20">
                      <el-col :span="4">
                        <el-form-item>
                          <el-button type="primary" @click="addFruitConfig">新增行</el-button>
                        </el-form-item>
                      </el-col>
                    </el-row>
                    <el-row :gutter="20" v-for="(item, index) in ruleForm.fruitConfig">
                      <el-col :span="10">
                        <el-form-item label="水果名称" prop="'fruit' + index">
                          <el-input type="text" v-model="item.fruit" autocomplete="off" maxlength="50">
                          </el-input>
                        </el-form-item>
                      </el-col>
                      <el-col :span="10">
                        <el-form-item label="水果售价" prop="'price' + index">
                          <el-input type="text" v-model="item.price" autocomplete="off" maxlength="50">
                          </el-input>
                        </el-form-item>
                      </el-col>
                      <el-col :span="4">
                        <el-button @click.prevent="removeFruitConfig(item)">删除行</el-button>
                      </el-col>
                    </el-row>
                    <el-row :gutter="20">
                      <el-col :span="4">
                        <el-form-item>
                          <el-button type="primary" @click="submitForm">确 定</el-button>
                        </el-form-item>
                      </el-col>
                    </el-row>
                  </el-form>
                </el-row>-->
      </el-col>
    </el-row>
  </div>
</template>

<script setup>
import {onMounted, ref} from 'vue' // vue相关方法
import {Map, View} from 'ol' // 地图实例方法、视图方法
import Tile from 'ol/layer/Tile' // 瓦片渲染方法
import TileLayer from 'ol/layer/Tile'
import OSM from 'ol/source/OSM' // OSM瓦片【OSM不能在实际开发中使用，因为OSM里中国地图的边界有点问题！！！！】
import 'ol/ol.css'
import VectorSource from "ol/source/Vector"; // 地图样式
import VectorLayer from "ol/layer/Vector";
import {GeoJSON, WKT} from "ol/format";
import {XYZ} from "ol/source";
import sichuan from "../../data/geojson.json";
import sichuan1 from "../../data/geojson1.json";
import {Draw} from "ol/interaction";
import * as control from "ol/control";
import * as coordinate from "ol/coordinate";
import {ScaleLine} from "ol/control";

/*import {reactive, toRefs, ref} from 'vue';
// 参数声明
const formRef = ref(null);
const state = reactive({
  ruleForm: {
    fruitConfig: [{
      fruit: '',
      price: ''
    }]
  },
})


// 数据解构
const {
  ruleForm,
  rules
} = {
  ...toRefs(state)
};*/


// 一个是属性,另一个是context上下文对象,包括(emit事件函数,slots插槽,attrs值对象)
let map = ref(null) // 存放地图实例

// const feature = new WKT().readFeature(wkt, {
//   dataProjection: 'EPSG:4326',
//   featureProjection: 'EPSG:4326'
// });


const wkts = []
wkts.push('POLYGON ((121.17391850955012 32.35576923076922, 121.1738498441928 32.36363750137519, 121.17364386903697 32.37150337522971, 121.17330064682466 32.37936445631141, 121.17282028210468 32.38721835005884, 121.17220292120079 32.395062664099875, 121.17144875216708 32.40289500898047, 121.17055800473076 32.410712998892514, 121.16953095022211 32.41851425240053, 121.1683679014919 32.426296393167135, 121.16706921281605 32.434057050676856, 121.16563527978768 32.44179386095825, 121.1640665391967 32.44950446730394, 121.16236346889667 32.45718652098856, 121.16052658765933 32.464837681984115, 121.1585564550165 32.472455619672864, 121.15645367108965 32.48003801355719, 121.15421887640713 32.48758255396646, 121.15185275170907 32.49508694276058, 121.14935601773996 32.50254889403002, 121.14672943502916 32.50996613479215, 121.14397380365921 32.51733640568357, 121.14108996302211 32.52465746164838, 121.13807879156366 32.53192707262201, 121.13494120651585 32.53914302421053, 121.13167816361748 32.54630311836518, 121.12829065682304 32.55340517405193, 121.12477971799991 32.560447027915814, 121.12114641661407 32.56742653493993, 121.1173918594043 32.57434156909883, 121.11351719004512 32.581190024006105, 121.10952358879833 32.587969813556064, 121.10541227215357 32.59467887255913, 121.10118449245772 32.60131515737094, 121.09684153753342 32.607876646514846, 121.09238473028682 32.614361341297695, 121.0878154283046 32.620767266418646, 121.08313502344036 32.62709247057084, 121.0783449413908 32.63333502703582, 121.0734466412613 32.63949303427042, 121.06844161512153 32.645564616485984, 121.06333138755093 32.65154792421974, 121.05811751517435 32.6574411348982, 121.0528015861878 32.66324245339231, 121.04738521987476 32.66895011256424, 121.04187006611285 32.67456237380572, 121.03625780487137 32.68007752756762, 121.03055014569944 32.68549389388067, 121.02474882720533 32.69080982286722, 121.01885561652686 32.69602369524381, 121.0128723087931 32.70113392281439, 121.00680072657755 32.70613894895416, 121.00064271934295 32.71103724908367, 120.99440016287797 32.71582733113323, 120.98807495872578 32.720507735997465, 120.98166903360483 32.7250770379797, 120.97518433882198 32.7295338452263, 120.96862284967807 32.73387680015059, 120.96198656486627 32.73810457984644, 120.9552775058632 32.742215896491196, 120.94849771631323 32.746209497737986, 120.94164926140596 32.75008416709717, 120.93473422724706 32.75383872430694, 120.92775472022295 32.757472025692785, 120.92071286635907 32.76098296451592, 120.91361081067231 32.76437047131036, 120.90645071651765 32.76763351420872, 120.89923476492913 32.77077109925652, 120.89196515395551 32.773782270714975, 120.8846440979907 32.77666611135208, 120.87727382709927 32.779421742722036, 120.86985658633715 32.78204832543283, 120.8623946350677 32.78454505940194, 120.85489024627358 32.786911184100006, 120.84734570586431 32.78914597878252, 120.83976331198 32.79124876270937, 120.83214537429124 32.79321889535221, 120.82449421329568 32.79505577658954, 120.81681215961108 32.79675884688956, 120.80910155326538 32.79832758748054, 120.80136474298399 32.79976152050891, 120.79360408547426 32.801060209184776, 120.78582194470766 32.80222325791499, 120.77802069119964 32.80325031242363, 120.7702027012876 32.80414105985995, 120.762370356407 32.80489522889366, 120.75452604236597 32.80551258979756, 120.74667214861854 32.805992954517535, 120.73881106753684 32.80633617672984, 120.73094519368232 32.80654215188567, 120.72307692307635 32.80661081724299, 120.71520865247038 32.80654215188567, 120.70734277861585 32.80633617672984, 120.69948169753415 32.805992954517535, 120.69162780378673 32.80551258979756, 120.6837834897457 32.80489522889366, 120.6759511448651 32.80414105985995, 120.66813315495305 32.80325031242363, 120.66033190144503 32.80222325791499, 120.65254976067844 32.801060209184776, 120.6447891031687 32.79976152050891, 120.63705229288732 32.79832758748054, 120.62934168654162 32.79675884688956, 120.62165963285702 32.79505577658954, 120.61400847186145 32.79321889535221, 120.6063905341727 32.79124876270937, 120.59880814028838 32.78914597878252, 120.59126359987911 32.786911184100006, 120.583759211085 32.78454505940194, 120.57629725981555 32.78204832543283, 120.56888001905342 32.779421742722036, 120.561509748162 32.77666611135208, 120.55418869219719 32.773782270714975, 120.54691908122356 32.77077109925652, 120.53970312963504 32.76763351420872, 120.53254303548039 32.76437047131036, 120.52544097979363 32.76098296451592, 120.51839912592975 32.757472025692785, 120.51141961890563 32.75383872430694, 120.50450458474674 32.75008416709717, 120.49765612983947 32.746209497737986, 120.4908763402895 32.742215896491196, 120.48416728128643 32.73810457984644, 120.47753099647463 32.73387680015059, 120.47096950733072 32.7295338452263, 120.46448481254787 32.7250770379797, 120.45807888742692 32.720507735997465, 120.45175368327473 32.71582733113323, 120.44551112680975 32.71103724908367, 120.43935311957515 32.70613894895416, 120.43328153735959 32.70113392281439, 120.42729822962583 32.69602369524381, 120.42140501894737 32.69080982286722, 120.41560370045326 32.68549389388067, 120.40989604128133 32.68007752756762, 120.40428378003985 32.67456237380572, 120.39876862627794 32.66895011256424, 120.3933522599649 32.66324245339231, 120.38803633097835 32.6574411348982, 120.38282245860177 32.65154792421974, 120.37771223103117 32.645564616485984, 120.3727072048914 32.63949303427042, 120.3678089047619 32.63333502703582, 120.36301882271233 32.62709247057084, 120.3583384178481 32.620767266418646, 120.35376911586587 32.614361341297695, 120.34931230861928 32.607876646514846, 120.34496935369498 32.60131515737094, 120.34074157399913 32.59467887255913, 120.33663025735437 32.587969813556064, 120.33263665610758 32.581190024006105, 120.3287619867484 32.57434156909883, 120.32500742953863 32.56742653493993, 120.32137412815278 32.560447027915814, 120.31786318932966 32.55340517405193, 120.31447568253522 32.54630311836518, 120.31121263963685 32.53914302421053, 120.30807505458904 32.53192707262201, 120.30506388313059 32.52465746164838, 120.30218004249349 32.51733640568357, 120.29942441112354 32.50996613479215, 120.29679782841274 32.50254889403002, 120.29430109444363 32.49508694276058, 120.29193496974557 32.48758255396646, 120.28970017506305 32.48003801355719, 120.2875973911362 32.472455619672864, 120.28562725849336 32.464837681984115, 120.28379037725603 32.45718652098856, 120.282087306956 32.44950446730394, 120.28051856636502 32.44179386095825, 120.27908463333665 32.434057050676856, 120.27778594466079 32.426296393167135, 120.27662289593059 32.41851425240053, 120.27559584142193 32.410712998892514, 120.27470509398562 32.40289500898047, 120.2739509249519 32.395062664099875, 120.27333356404802 32.38721835005884, 120.27285319932804 32.37936445631141, 120.27250997711573 32.371503375229715, 120.2723040019599 32.36363750137519, 120.27223533660258 32.35576923076922, 120.2723040019599 32.34790096016325, 120.27250997711573 32.34003508630873, 120.27285319932804 32.33217400522703, 120.273333564048 32.3243201114796, 120.2739509249519 32.316475797438564, 120.27470509398562 32.308643452557966, 120.27559584142193 32.300825462645925, 120.27662289593059 32.29302420913791, 120.27778594466079 32.2852420683713, 120.27908463333665 32.27748141086158, 120.28051856636502 32.26974460058019, 120.282087306956 32.2620339942345, 120.28379037725603 32.25435194054988, 120.28562725849336 32.246700779554324, 120.2875973911362 32.239082841865574, 120.28970017506305 32.23150044798125, 120.29193496974557 32.22395590757198, 120.29430109444363 32.21645151877786, 120.29679782841274 32.20898956750842, 120.29942441112354 32.20157232674629, 120.30218004249349 32.194202055854866, 120.30506388313059 32.18688099989006, 120.30807505458904 32.17961138891643, 120.31121263963685 32.17239543732791, 120.31447568253522 32.16523534317326, 120.31786318932966 32.15813328748651, 120.32137412815278 32.151091433622625, 120.32500742953863 32.144111926598505, 120.3287619867484 32.13719689243961, 120.33263665610758 32.130348437532334, 120.33663025735437 32.123568647982374, 120.34074157399913 32.11685958897931, 120.34496935369498 32.1102233041675, 120.34931230861928 32.10366181502359, 120.35376911586587 32.097177120240744, 120.3583384178481 32.09077119511979, 120.36301882271233 32.0844459909676, 120.3678089047619 32.07820343450262, 120.3727072048914 32.072045427268016, 120.37771223103117 32.065973845052454, 120.38282245860177 32.0599905373187, 120.38803633097835 32.05409732664024, 120.3933522599649 32.04829600814613, 120.39876862627794 32.0425883489742, 120.40428378003985 32.03697608773272, 120.40989604128133 32.03146093397082, 120.41560370045326 32.02604456765777, 120.42140501894737 32.020728638671216, 120.42729822962583 32.01551476629463, 120.43328153735959 32.010404538724046, 120.43935311957515 32.005399512584276, 120.44551112680975 32.00050121245477, 120.45175368327473 31.99571113040521, 120.45807888742692 31.991030725540977, 120.46448481254787 31.986461423558737, 120.47096950733072 31.98200461631214, 120.47753099647463 31.977661661387845, 120.48416728128643 31.973433881691996, 120.4908763402895 31.96932256504724, 120.49765612983947 31.965328963800456, 120.50450458474674 31.96145429444127, 120.51141961890563 31.957699737231504, 120.51839912592975 31.954066435845654, 120.52544097979363 31.950555497022524, 120.53254303548039 31.947167990228085, 120.53970312963504 31.943904947329724, 120.54691908122356 31.940767362281914, 120.55418869219719 31.937756190823464, 120.561509748162 31.93487235018636, 120.56888001905342 31.932116718816406, 120.57629725981555 31.929490136105603, 120.583759211085 31.926993402136496, 120.59126359987911 31.924627277438432, 120.59880814028838 31.92239248275592, 120.6063905341727 31.92028969882907, 120.61400847186145 31.91831956618623, 120.62165963285702 31.916482684948893, 120.62934168654162 31.91477961464888, 120.63705229288732 31.913210874057896, 120.6447891031687 31.911776941029526, 120.65254976067844 31.910478252353663, 120.66033190144503 31.909315203623454, 120.66813315495305 31.90828814911481, 120.6759511448651 31.907397401678487, 120.6837834897457 31.90664323264478, 120.69162780378673 31.90602587174088, 120.69948169753415 31.905545507020904, 120.70734277861585 31.905202284808595, 120.71520865247038 31.90499630965277, 120.72307692307635 31.904927644295448, 120.73094519368232 31.90499630965277, 120.73881106753684 31.905202284808595, 120.74667214861854 31.905545507020904, 120.75452604236597 31.90602587174088, 120.762370356407 31.90664323264478, 120.7702027012876 31.907397401678487, 120.77802069119964 31.90828814911481, 120.78582194470766 31.909315203623454, 120.79360408547426 31.910478252353663, 120.80136474298399 31.911776941029526, 120.80910155326538 31.913210874057896, 120.81681215961108 31.91477961464888, 120.82449421329568 31.916482684948893, 120.83214537429124 31.91831956618623, 120.83976331198 31.92028969882907, 120.84734570586431 31.92239248275592, 120.85489024627358 31.924627277438432, 120.8623946350677 31.926993402136496, 120.86985658633715 31.929490136105603, 120.87727382709927 31.932116718816406, 120.8846440979907 31.93487235018636, 120.89196515395551 31.937756190823464, 120.89923476492913 31.940767362281914, 120.90645071651765 31.943904947329724, 120.91361081067231 31.947167990228085, 120.92071286635907 31.950555497022524, 120.92775472022295 31.954066435845654, 120.93473422724706 31.957699737231504, 120.94164926140596 31.96145429444127, 120.94849771631323 31.965328963800456, 120.9552775058632 31.96932256504724, 120.96198656486627 31.973433881691996, 120.96862284967807 31.977661661387845, 120.97518433882198 31.98200461631214, 120.98166903360483 31.986461423558737, 120.98807495872578 31.991030725540977, 120.99440016287797 31.99571113040521, 121.00064271934295 32.00050121245477, 121.00680072657755 32.005399512584276, 121.0128723087931 32.010404538724046, 121.01885561652686 32.01551476629463, 121.02474882720533 32.020728638671216, 121.03055014569944 32.02604456765777, 121.03625780487137 32.03146093397082, 121.04187006611285 32.03697608773272, 121.04738521987476 32.0425883489742, 121.0528015861878 32.04829600814613, 121.05811751517435 32.05409732664023, 121.06333138755093 32.0599905373187, 121.06844161512153 32.065973845052454, 121.0734466412613 32.072045427268016, 121.0783449413908 32.07820343450262, 121.08313502344036 32.0844459909676, 121.0878154283046 32.09077119511979, 121.09238473028682 32.097177120240744, 121.09684153753342 32.10366181502359, 121.10118449245772 32.1102233041675, 121.10541227215357 32.11685958897931, 121.10952358879833 32.123568647982374, 121.11351719004512 32.130348437532334, 121.1173918594043 32.13719689243961, 121.12114641661407 32.144111926598505, 121.12477971799991 32.151091433622625, 121.12829065682304 32.15813328748651, 121.13167816361748 32.16523534317326, 121.13494120651585 32.17239543732791, 121.13807879156366 32.17961138891643, 121.14108996302211 32.18688099989006, 121.14397380365921 32.194202055854866, 121.14672943502916 32.20157232674629, 121.14935601773996 32.20898956750842, 121.15185275170907 32.21645151877786, 121.15421887640713 32.22395590757198, 121.15645367108965 32.23150044798125, 121.1585564550165 32.239082841865574, 121.16052658765933 32.246700779554324, 121.16236346889667 32.25435194054988, 121.1640665391967 32.2620339942345, 121.16563527978768 32.26974460058019, 121.16706921281605 32.27748141086158, 121.1683679014919 32.2852420683713, 121.16953095022211 32.29302420913791, 121.17055800473076 32.300825462645925, 121.17144875216708 32.308643452557966, 121.17220292120079 32.316475797438564, 121.17282028210468 32.3243201114796, 121.17330064682466 32.33217400522703, 121.17364386903697 32.34003508630873, 121.1738498441928 32.34790096016325, 121.17391850955012 32.35576923076922))')


let geofiles = []
geofiles.push(sichuan)
geofiles.push(sichuan1)

let features = [];
addWkt();
// addGeo();


// features.push(getFeatureByWKT(wkt))
function addGeo() {
  for (let i = 0; i < geofiles.length; i++) {
    let readFeature = new GeoJSON().readFeature(geofiles[i]);
    readFeature.setId('g' + i)
    features.push(readFeature);
  }
}

function addWkt() {
  for (let i = 0; i < wkts.length; i++) {
    let readFeature = new WKT().readFeature(wkts[i]);
    readFeature.setId('w' + i)
    features.push(readFeature);
  }
}

let source = new VectorSource()
let layers = [
  //图层
  new Tile({   // 使用瓦片渲染方法
    // 空白底图,生产环境不可使用
    source: new OSM(),
  }),
  new Tile({
    source: new XYZ({url: 'http://t4.tianditu.com/DataServer?T=vec_w&tk=049df85c66a8dedc9a2d3dda08793769&x={x}&y={y}&l={z}'}),
    // source: new OSM(),
  }),
  new TileLayer({
    source: new XYZ({url: 'http://t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=049df85c66a8dedc9a2d3dda08793769'}),
  }),
  new VectorLayer({
    source: new VectorSource({
      features: features
    })
  }),
  new VectorLayer({
    source: source
  })
];


// 实例化鼠标位置控件
let mousePositionControl = new control.MousePosition({
  coordinateFormat: coordinate.createStringXY(6), //坐标格式
  projection: 'EPSG:4326', //地图投影坐标系
});

// 添加比例尺
let scaleline = new ScaleLine({
  units: "metric"
})

function initMap() {
  // 地图实例
  map = new Map({
    target: 'map',                         // 对应页面里 id 为 map 的元素
    layers: layers,  // 图层
    view: new View({                       // 地图视图
      projection: "EPSG:4326",             // 坐标系，有EPSG:4326和EPSG:3857
      center: [114.064839, 22.548857],     // 深圳坐标
      minZoom: 1,                          // 地图缩放最小级别
      zoom: 6                             // 地图缩放级别（打开页面时默认级别）
    }),
    controls: control.defaults().extend([scaleline, mousePositionControl])
  })
}

onMounted(() => {
  initMap()
})

//保存这个控件状态,保证不会改变成别的对象
let draw = ref(null)


// function submitForm() { // 点击确定按钮，输出行内数据
//   const fruitConfig = state.ruleForm.fruitConfig;
//   console.log(fruitConfig);
//   console.log("水果名称：" + fruitConfig[0].fruit);
//   console.log("水果售价：" + fruitConfig[0].price);
// }

// function removeFruitConfig(item) { // 删除水果、售价行
//   const index = state.ruleForm.fruitConfig.indexOf(item)
//   if (index !== -1) {
//     state.ruleForm.fruitConfig.splice(index, 1)
//   }
// }
//
// function addFruitConfig() { // 新增水果、售价行
//   state.ruleForm.fruitConfig.push({
//     fruit: '',
//     price: ''
//   })
// }

function addInteraction(type) {
  // 添加交互绘制控件
  draw = new Draw({
    source: source,
    type: type
  });
  map.addInteraction(draw);
  // 监听点
  draw.on('drawend', (event) => {
    // event.feature 结束时的线
    let feature = event.feature;
    let a = JSON.stringify(feature.getGeometry().getCoordinates());
    // document.getElementById('points').innerHTML = a
    console.log(a)


    let strwkt = new WKT().writeFeature(feature, {
      dataProjection: 'EPSG:4326',//目标坐标系
      featureProjection: 'EPSG:4326'  //当前坐标系
    });
    document.getElementById('wkt').innerHTML = strwkt
    console.log(strwkt)

    return a
  })
}

const drawPoint = () => {
  //退出其他绘制
  exitDraw();
  // 绘制点
  addInteraction("Point");
}

function drawLine() {
  //退出其他绘制
  exitDraw();
  // 绘制线
  addInteraction("LineString");
}

function drawPolygon() {
  //退出其他绘制
  exitDraw();
  // 绘制面
  addInteraction("Polygon");
}

function drawCircle() {
  //退出其他绘制
  exitDraw();
  // 绘制圆
  addInteraction("Circle");
}

function clearDraw() {
  // 清空绘制
  source.clear();
}

function exitDraw() {
  // 退出绘制模式
  if (draw) {
    // 移除交互
    map.removeInteraction(draw);
    source.clear();
    draw = null;
  }
}

// 撤回操作
function removeLastPoint() {
  draw.removeLastPoint()
}


// }


// };
</script>
<!--样式,坐标转换,输入显示,文件读取,-->


<style scoped>
.home {
  width: 1024px;
}

.map__x {
  width: 600px;
  height: 530px;
  border: 1px solid #eee;
//position: absolute; float: left; float: left;
}

.attribute {
  width: 410px;
  height: 530px;
  border: 1px solid #eee;
  float: left;
}

</style>
